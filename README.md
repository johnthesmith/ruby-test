Тестовое задание на ruby

#-------------------------------------------------------------------------------
# Работы
#-------------------------------------------------------------------------------
#   +Настроил систему [nginx]->[passenger]->[rails]->[sqllite]
#   +Разобрался с синтаксисом ruby, написал тестовый отладочный модуль
#   +Разобрался с gem (мало им apt, но возможно для win)
#   +Поставил rails (!!!)
#   +Разобрался с созданием приложений
#   +Создал приложение
#   +Разобрался с Controller
#   +Разобрался с View
#   -Разобрался с Model
#   +Разобрался со SLIM (!!!) 0.1
#   +Соорудил основу странцу
#   +Разобрался с link_to
#   +Подключил bootstrap 0.3
#   -Модель блога 1.1
#   -Авторизация 1.2

#-------------------------------------------------------------------------------
# Надо сделать
#-------------------------------------------------------------------------------

#   1. Всвязи с ограниченностью времени и отсутсвием заботы по безопасности, все
#   установки выполнены от root. На продакшене недопустимо.
#   2. Надо настроить автозапуск но сейчас некогда.
#   3. Разобраться как ставить это все без passenger. Вручную собрать nginx.
#   4. sqlite категорически не подходит для чего то серьезного но пока ладно.





#-------------------------------------------------------------------------------
# Операционная система
#-------------------------------------------------------------------------------

#   Установка производится на ЧИСТЫЙ сервер Ubuntu 18.04.
#   Использован сервер aruba hdd:ssd 20gb; core:1; mem:1gb; 2.75ec/month.

#-------------------------------------------------------------------------------
# Обновление системы:
#-------------------------------------------------------------------------------

sudo apt update
sudo apt upgrade 
sudo apt autoremove

#-------------------------------------------------------------------------------
# Установка необходимого ПО
#-------------------------------------------------------------------------------

#   Ставим:
#       mc - менеджер редактор
#       git - выгрузка на гитхаб
#       ruby - в нем есть gem управление пакетами при руби (мало apt)
#       sqlite - БД, нужен будет для работоспособности rails 
#       nodejs - интепритатор js нужен для работоспособности rails (костыль)

sudo apt install mc git ruby sqlite nodejs

#-------------------------------------------------------------------------------
# Установка passenger
#-------------------------------------------------------------------------------

#   passengir - автоматизированный костыль, предоставляющий интерфейс для 
#   установки webserver+ruby. Можно ставить и apach.
#   Материал: https://www.phusionpassenger.com/library/install/nginx/install/oss/rubygems_rvm/
#   Cтавим passenger через gem который появляется после ruby.

sudo gem install passenger

#-------------------------------------------------------------------------------
# Установка nginx+ruby
#-------------------------------------------------------------------------------
#   Далее необходимо установить passenger-install-nginx-module. При установке 
#   сообщает о необходимых библиотеках. Их ставим заранее.

sudo apt install libcurl4-gnutls-dev libssl-dev zlib1g-dev ruby-dev

#   Теперь сам passenger-install-nginx-module.

passenger-install-nginx-module

#   Возможно будет сообщение о необходимости иных библиотек. Тогда повторить.
#   Красных сообщений не должно быть.
#   При установке будут заданы вопросы. Ответы:
#       1. This installer will compile and install Nginx with Passenger support.
#       Ruby
#       1. Yes: download, compile and install Nginx for me. (recommended)
#       Please specify a prefix directory [/opt/nginx]: 
#   Ждем завершение установки. Надеемся на лучшее.

#   Проверяем успешность установки для Passenger.
passenger-config validate-install

#   Запускаем Nginx. system.d использовать нельзя так как passenger поставил
#   его на свое усмотрение (костыль).
/opt/nginx/sbin/nginx

#   [i] Чтение конфига nginx: /opt/nginx/sbin/nginx -s reload
#   [i] Остановка nginx: /opt/nginx/sbin/nginx -s stop

#   Проверка статуса установленных серверов. Нас интересует Nginx. Должен 
#   присутсвовать в процессах. Кроме того должен присутсовать passenger process
#   Пока не знаю в чем дело но бывает что его нет. Тогда неработает.
passenger-memory-stats

#   Nginx должен работать при обращении к хосту по http.

#-------------------------------------------------------------------------------
# Установка rails
#-------------------------------------------------------------------------------

#   Установка проивзодится через gem.
gem install rails

#   Рэйл требует библиотеку gem sqlite3 а та требует sqlite3 и libsqlite3-dev.
sudo apt install sqlite3 libsqlite3-dev
gem install sqlite3

#-------------------------------------------------------------------------------
# Создание приложения
#-------------------------------------------------------------------------------

#   Созадем каталог для приложений (его изначально нет)
mkdir /opt/nginx/app

#   Топаем в каталог
cd /opt/nginx/app

#   Создаем приложение AppName
#   Должно все завершится без красных строк. Ждем надеемся. В результате 
#   появлется каталог [AppNews] в нем некая структура.
rails new [AppName]

#   Заходим в AppName
cd /opt/nginx/app/[AppName]

#   Создаем базу данных. Оно думает. Создает базу.
rake db:create



#-------------------------------------------------------------------------------
# Настройка nginx
#-------------------------------------------------------------------------------
# Вносим изменения в /opt/nginx/conf/nginx.conf
#http {
#    # эти строчки должны быть сразу
#    passenger_root /var/lib/gems/2.5.0/gems/passenger-6.0.2;
#    passenger_ruby /usr/bin/ruby2.5;
#    # пользователь от которого работает passenger
#    passenger_default_user root; 
#    # группа от которого работает passenger
#    passenger_default_group root;
#      
#    server {
#        listen       80;
#        server_name  94.177.251.38;
#        passenger_enabled on;
#        #без нижеследующего это оно не работает!!! обошлось в час разбирательств!!!
#        passenger_app_env development;
#        root /opt/nginx/app/[AppName]/public;
#
#        location / {
#            #root   html/task/public;
#            #index  index.html index.htm;
#        }

#------------------------------------------------------------------------------
# Подключение гемов
#------------------------------------------------------------------------------
#   Отдельно стами разные gem для функционала
#   Поставил для конвертации но пока не понадобилось
gem install html2slim
#   Поставил в процессе разбительств - возможно надо убрать
gem install execjs
#   Это для поддержки slim. Сам не подхватывался после установки и bundle install. Пришлось перезапустить nginx
gem install slim-rails
#   Пришлость поставить для исполнения пункта 0.3.
gem install bootstrap

# подключаем нужные гемы в файле /opt/nxing/app/[AppName]/GemFile
#>  gem 'slim-rails'
#>  gem 'bootstrap'

#   Заходим в AppName
cd /opt/nginx/app/[AppName]
#   Устраиваем переинициализацию не знаю пока зачем (но надо)
bundle install


#------------------------------------------------------------------------------
# Создание контреллера
#------------------------------------------------------------------------------
# Статья http://rusrails.ru/getting-started-with-rails

# Контроллер - это хрень которая отображается в URL после имени домена
# Метод - отображается в URL после имени контроллера
# Итого URL выгляди следующим образом:  protocol://domain/Controller/Method

# rails generate controller [Controller] [Method]
# морда сраницы содержится тут: /opt/nginx/app/[AppName]/views/layouts/application.html.erb

# Создал контроллер information note для размещения вот этого файла
rails generate controller information note
# Создал контроллер main index для размещения головной информаци
rails generate controller main index

#------------------------------------------------------------------------------
# Мое мнение
#------------------------------------------------------------------------------
#Касательно Ruby:

#   1. Значительно хуже представлена техническая СПРАВОЧНАЯ документация нежели PHP.
#   2. Язык обладает cвойством - читать сложнее чем писать. Так как 
#   в крупных проектах код пишут реже чем читают, считаю существенным недостатком.